<!DOCTYPE html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Microphone MATRIX</title>
  <link rel="shortcut icon" href="../../../img/favicon.ico">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css">
  <link rel="stylesheet" href="../../../css/theme.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-light container">
  <a class="navbar-brand" href="/">
    <img src="../../../img/everloop.png" width="38" height="38" class="d-inline-block align-top" alt="">
    <span>MATRIX</span>
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbar-menu">
    <ul class="navbar-nav ml-auto">
      <li class="nav-item">
        <a class="nav-link">
          For Home
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link">
          Creator
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link">
          Voice
        </a>
      </li>
      <li class="nav-item">
        <a href="https://apps.matrix.one/" target="blank" class="nav-link">
          Apps
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link">
          Store
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link">
          OS
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link active">
          Developers
        </a>
      </li>
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <img src="/img/english.png" alt="English">
        </a>
        <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
          <a class="dropdown-item" href="#">
            <span>Português</span>
            <img src="/img/brazil.png" alt="Portuguese" />
          </a>
          <a class="dropdown-item" href="#">
            <span>Español</span>
            <img src="/img/spain.png" alt="Spanish" />
          </a>
        </div>
      </li>
    </ul>
  </div>
</nav>

  <div class="header">
    <div class="container">
      <div class="jumbotron">
        <div class="row">
          <div class="col-sm-8">
            
            <h1>Microphone</h1>
            
          </div>
          <div class="col-sm-4">
            <form action="../../../search.html" method="get">
              <input class="form-control" type="search" name="q" placeholder="Search" />
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="content">
    <div class="container">
      <div class="row">
        <div class="sidebar col-lg-2">
          <h3>Documentation</h3>
          <ul>
              

<!-- link to depth-first url found  -->
  

<!-- If there are no children, use the url (simple)  -->
<li>
  <a href="../../.." class="">
    Overview
  </a>
</li>


  

<!-- link to depth-first url found  -->
  

<!-- If there are no children, use the url (simple)  -->
<li>
  <a href="../../../setup/" class="">
    Device Setup
  </a>
</li>


  


<!-- Children complicate things  -->

<!-- link to depth-first url found  -->
  

<!-- print root node  -->
<li class="">
  <a href="../../../matrix-os/" class="">
    MATRIX OS
  </a>
</li>

<ul class="subnav">
   
  <!-- only 1 deep, print menu items  -->
     
  <!-- 2 deep  -->
  <!-- print subroot  -->
  <li>
    <a href="../../../matrix-os/getting-started/prerequisites/" class="">
      Getting Started
    </a>
  </li>

  <ul class="subnav">
      
        
        
        
        
        
      
  </ul>

    
  <!-- 2 deep  -->
  <!-- print subroot  -->
  <li>
    <a href="../../../matrix-os/overview/" class="">
      Overview
    </a>
  </li>

  <ul class="subnav">
        
        
        
        
        
        
        
      
  </ul>

    
  <!-- 2 deep  -->
  <!-- print subroot  -->
  <li>
    <a href="../../../matrix-os/examples/" class="">
      Examples
    </a>
  </li>

  <ul class="subnav">
        
        
        
        
      
  </ul>

    
  <!-- 2 deep  -->
  <!-- print subroot  -->
  <li>
    <a href="../../../matrix-os/reference/" class="">
      Reference
    </a>
  </li>

  <ul class="subnav">
        
        
        
        
        
        
        
        
        
        
        
        
        
      
  </ul>

    
  <!-- only 1 deep, print menu items  -->
    
     
</ul>

  


<!-- Children complicate things  -->

<!-- link to depth-first url found  -->
  

<!-- print root node  -->
<li class="">
  <a href="../../../matrix-core/" class="">
    MATRIX CORE
  </a>
</li>

<ul class="subnav">
   
  <!-- only 1 deep, print menu items  -->
     
  <!-- 2 deep  -->
  <!-- print subroot  -->
  <li>
    <a href="../../../matrix-core/getting-started/prerequisites/" class="">
      Getting Started
    </a>
  </li>

  <ul class="subnav">
      
        
        
        
      
  </ul>

    
  <!-- 2 deep  -->
  <!-- print subroot  -->
  <li>
    <a href="../../../matrix-core/examples/pytests/" class="">
      Examples
    </a>
  </li>

  <ul class="subnav">
      
        
      
  </ul>

    
  <!-- 2 deep  -->
  <!-- print subroot  -->
  <li>
    <a href="../../../matrix-core/reference/everloop/" class="">
      Reference
    </a>
  </li>

  <ul class="subnav">
      
        
        
        
        
        
        
        
      
  </ul>

    
  <!-- only 1 deep, print menu items  -->
    
     
</ul>

  


<!-- Children complicate things  -->

<!-- link to depth-first url found  -->
  

<!-- print root node  -->
<li class="">
  <a href="../../" class="active">
    MATRIX HAL
  </a>
</li>

<ul class="subnav">
   
  <!-- only 1 deep, print menu items  -->
     
  <!-- 2 deep  -->
  <!-- print subroot  -->
  <li>
    <a href="../../getting-started/installation/" class="">
      Getting Started
    </a>
  </li>

  <ul class="subnav">
      
        
        
      
  </ul>

    
  <!-- 2 deep  -->
  <!-- print subroot  -->
  <li>
    <a href="../../datasheets/creator/" class="">
      Boards
    </a>
  </li>

  <ul class="subnav">
      
        
      
  </ul>

    
  <!-- 2 deep  -->
  <!-- print subroot  -->
  <li>
    <a href="../" class="active">
      Components
    </a>
  </li>

  <ul class="subnav">
        
    
    <li><a href="../fpga/" class="">FPGA</a></li>
        
    
    <li><a href="./" class="active">Microphone</a></li>
        
    
    <li><a href="../Sam3/" class="">SAM3</a></li>
        
    
    <li><a href="../Sam3mcu/" class="">SAM3MCU</a></li>
        
    
    <li><a href="../pinout/" class="">Pinout</a></li>
        
    
    <li><a href="../SPI/" class="">SPI</a></li>
      
  </ul>

    
  <!-- 2 deep  -->
  <!-- print subroot  -->
  <li>
    <a href="../../tools/" class="">
      Tools
    </a>
  </li>

  <ul class="subnav">
      
        
      
  </ul>

    
  <!-- 2 deep  -->
  <!-- print subroot  -->
  <li>
    <a href="../../examples/alexa/" class="">
      Examples
    </a>
  </li>

  <ul class="subnav">
      
      
  </ul>

    
  <!-- only 1 deep, print menu items  -->
    
  
  <li><a href="../../troubleshooting/" class="">Troubleshooting</a></li>
     
</ul>

  

<!-- link to depth-first url found  -->
  

<!-- If there are no children, use the url (simple)  -->
<li>
  <a href="../../../help/" class="">
    Support
  </a>
</li>


 
          </ul>
        </div>
        <div id="content" class="col-lg-8">
           <h3 id="microphone">Microphone</h3>
<h4 id="1-mic-array-on-matrix-creator">1. Mic Array on MATRIX Creator</h4>
<p><img alt="Mic Position" src="../../img/mic_position.png" /></p>
<h5 id="position-xy-of-each-mic-in-the-array">Position [x,y] of each mic in the array:</h5>
<table>
<thead>
<tr>
<th>Mic</th>
<th>X</th>
<th>Y</th>
</tr>
</thead>
<tbody>
<tr>
<td>M1</td>
<td>20.0908795</td>
<td>-48.5036755</td>
</tr>
<tr>
<td>M2</td>
<td>-20.0908795</td>
<td>-48.5036755</td>
</tr>
<tr>
<td>M3</td>
<td>-48.5036755</td>
<td>-20.0908795</td>
</tr>
<tr>
<td>M4</td>
<td>-48.5036755</td>
<td>20.0908795</td>
</tr>
<tr>
<td>M5</td>
<td>-20.0908795</td>
<td>48.5036755</td>
</tr>
<tr>
<td>M6</td>
<td>20.0908795</td>
<td>48.5036755</td>
</tr>
<tr>
<td>M7</td>
<td>48.5036755</td>
<td>20.0908795</td>
</tr>
<tr>
<td>M8</td>
<td>48.5036755</td>
<td>-20.0908795</td>
</tr>
</tbody>
</table>
<h5 id="connection-to-the-fpga">Connection to the FPGA</h5>
<p>from the <a href="https://github.com/matrix-io/matrix-creator-fpga/blob/master/creator_core/creator.ucf">creator.ucf</a> :</p>
<table>
<thead>
<tr>
<th>Mic</th>
<th>FPGA pin</th>
<th>PDM_Data</th>
</tr>
</thead>
<tbody>
<tr>
<td>M1</td>
<td>P45</td>
<td>pdm_data&lt;0&gt;</td>
</tr>
<tr>
<td>M2</td>
<td>P46</td>
<td>pdm_data&lt;1&gt;</td>
</tr>
<tr>
<td>M3</td>
<td>P47</td>
<td>pdm_data&lt;2&gt;</td>
</tr>
<tr>
<td>M4</td>
<td>P58</td>
<td>pdm_data&lt;3&gt;</td>
</tr>
<tr>
<td>M5</td>
<td>P59</td>
<td>pdm_data&lt;4&gt;</td>
</tr>
<tr>
<td>M6</td>
<td>P64</td>
<td>pdm_data&lt;5&gt;</td>
</tr>
<tr>
<td>M7</td>
<td>P65</td>
<td>pdm_data&lt;6&gt;</td>
</tr>
<tr>
<td>M8</td>
<td>P44</td>
<td>pdm_data&lt;7&gt;</td>
</tr>
<tr>
<td>CLK</td>
<td>P47</td>
<td>pdm_clk</td>
</tr>
</tbody>
</table>
<h5 id="audio-specs">Audio specs:</h5>
<p>Sample Rate: 16 kHz
Bit Depth: 16 bit</p>
<p><strong>Note</strong>: An option for setting higher sample rates will be released soon.  Please keep in touch in the community announcements channel http://community.matrix.one/c/announcements.</p>
<h5 id="microphones-datasheet">Microphones Datasheet:</h5>
<p><a href="http://www.st.com/content/ccc/resource/technical/document/datasheet/57/af/88/31/7b/59/4f/77/DM00111225.pdf/files/DM00111225.pdf/jcr:content/translations/en.DM00111225.pdf">MP34DB02 - MEMS audio sensor omnidirectional digital microphone</a> </p>
<h4 id="2-how-to-get-microphone-data-from-c">2. How to get microphone data from C++</h4>
<p>You can use our lower software layer in C++ called HAL () (Hardware Abstraction Layer) to read data from the microphones.</p>
<h5 id="getting-and-compiling-hal">Getting and Compiling HAL</h5>
<pre><code>git clone https://github.com/matrix-io/matrix-creator-hal.git
cd matrix-creator-hal 
mkdir build &amp;&amp; cd build
cmake ..
make
</code></pre>
<h5 id="example-code">Example code</h5>
<p>The following example gets samples from all channels (mics) collected by the fpga.  </p>
<pre><code>... 
int main() {
    hal::WishboneBus bus;
    bus.SpiInit();
    hal::MicrophoneArray mics;
    mics.Setup(&amp;bus);
    std::valarray&lt;float&gt; magnitude(mics.Channels());

    mics.SetGain(8);
    std::cout &lt;&lt; "M1\t" &lt;&lt; "M2\t" &lt;&lt; "M3\t" &lt;&lt; "M4\t" &lt;&lt; "M5\t" &lt;&lt; "M6\t" &lt;&lt; "M7\t" &lt;&lt; "M8\t" &lt;&lt; std::endl;

    while (true) {
        mics.Read();
        magnitude = 0.0;
        for (unsigned int s = 0; s &lt; mics.NumberOfSamples(); s++) {
            for (unsigned int c = 0; c &lt; mics.Channels(); c++) {
              magnitude[c] = mics.At(s, c);
              std::cout &lt;&lt;  magnitude[c] &lt;&lt; "\t";
            }
            std::cout &lt;&lt; std::endl;
        }
    }
    return 0;
}
</code></pre>
<h4 id="3-example-demo-apps-for-mics">3. Example demo apps for mics</h4>
<p>The demo apps are in the folder <code>matrix-creator-hal/demos/</code> . They are built with HAL. To run them go to the demo folder :</p>
<pre><code>cd build/demos
./mic_demo
</code></pre>
<p>note: You can play with the demos to learn how to use HAL, and them use them as starting points for your own apps.</p>
<h5 id="mic_demo">mic_demo</h5>
<p>This demo maps each mic audio input to one specific led on the Everloop. You can make sounds close to the MATRIX Creator and see how the LEDs turn green when a sound is detected. Also the demo prints in the terminal the audio as numbers, e.g.:</p>
<pre><code>cd build/demos
./mic_demo
0   0   0   0   0   0   0   0   
0   0   0   0   0   0   0   0   
6   6   6   6   6   4   5   6   
3   6   4   4   2   2   2   2   
0   0   0   0   0   0   0   0   
0   0   0   0   0   0   0   0   
0   0   0   0   0   0   0   0   
3   5   5   4   4   4   5   4   
5   6   6   6   6   5   6   5   
1   0   1   2   2   1   1   1   
0   1   1   1   1   1   1   1   
0   1   1   0   1   0   0   0   
...
</code></pre>
<h5 id="mic_energy">mic_energy</h5>
<p>This demo is similar but instead of mapping the mic's audio individually takes all channels and maps the average of all mics. It maps at the same time in all LEDs and creates a very voice responsive red light. This demos does not print anything on the terminal.</p>
<pre><code>cd build/demos
./mic_energy
</code></pre>
<h5 id="micarray_recorder">micarray_recorder</h5>
<p>This demo records audio from all 8 channels (0-7) and the beamforming channel (channel 8) to raw files located in the same folder. After you launching the demo you will have these files:</p>
<pre><code>cd build/demos
./micarray_recorder
</code></pre>
<p>The default example records audio to raw files for 10 seconds and then stops. After recording the files are on the same folder <code>/demos</code> :</p>
<pre><code>cd build/demos
ls | grep raw
mic_16000_s16le_channel_0.raw
mic_16000_s16le_channel_1.raw
mic_16000_s16le_channel_2.raw
mic_16000_s16le_channel_3.raw
mic_16000_s16le_channel_4.raw
mic_16000_s16le_channel_5.raw
mic_16000_s16le_channel_6.raw
mic_16000_s16le_channel_7.raw
mic_16000_s16le_channel_8.raw
</code></pre>
<p>note: The data in the raw files is written in <code>int16_t</code>. </p>
<h5 id="direction_of_arrival_demo">direction_of_arrival_demo</h5>
<p>This demo shows a first implementation of direction of arrival detection. It shows the direction of arrival using the LEDs and also prints the result angle in the terminal. To test it run the demo and make sounds from different directions to the MATRIX Creator board to see how. </p>
<pre><code>./direction_of_arrival_demo
azimutal angle = 0, polar angle = 0, mic = 0
azimutal angle = 0, polar angle = 0, mic = 0
azimutal angle = -157.5, polar angle = 18, mic = 2
azimutal angle = -157.5, polar angle = 18, mic = 2
azimutal angle = -157.5, polar angle = 18, mic = 2
azimutal angle = 22.5, polar angle = 36, mic = 6
azimutal angle = -157.5, polar angle = 54, mic = 2
azimutal angle = -157.5, polar angle = 72, mic = 2
azimutal angle = -157.5, polar angle = 72, mic = 2
</code></pre>
<h4 id="record-convert-and-play-sounds">Record, Convert and Play sounds.</h4>
<h5 id="update-and-upgrade-raspbian">Update and upgrade Raspbian</h5>
<pre><code>sudo apt-get update
sudo apt-get upgrade
</code></pre>
<h5 id="install-alsa-tools-and-the-sox-utility">Install <em>Alsa tools</em> and the <em>sox</em> utility</h5>
<pre><code>sudo apt-get install sox alsa-utils
</code></pre>
<h5 id="run-the-volume-control">Run the volume control</h5>
<pre><code>alsamixer
</code></pre>
<h5 id="run-capture-and-check-the-recorded-files">Run capture and check the recorded files</h5>
<pre><code>cd demos
./micarray_recorder
ls -1 *raw
</code></pre>
<h5 id="convert-the-audio">Convert the audio</h5>
<pre><code>sox -r 16000 -c 1 -e signed -c 1 -e signed -b 16 mic_16000_s16le_channel_0.raw channel_0.wav
sox -r 16000 -c 1 -e signed -c 1 -e signed -b 16 mic_16000_s16le_channel_1.raw channel_1.wav
sox -r 16000 -c 1 -e signed -c 1 -e signed -b 16 mic_16000_s16le_channel_2.raw channel_2.wav
sox -r 16000 -c 1 -e signed -c 1 -e signed -b 16 mic_16000_s16le_channel_3.raw channel_3.wav
sox -r 16000 -c 1 -e signed -c 1 -e signed -b 16 mic_16000_s16le_channel_4.raw channel_4.wav
sox -r 16000 -c 1 -e signed -c 1 -e signed -b 16 mic_16000_s16le_channel_5.raw channel_5.wav
sox -r 16000 -c 1 -e signed -c 1 -e signed -b 16 mic_16000_s16le_channel_6.raw channel_6.wav
sox -r 16000 -c 1 -e signed -c 1 -e signed -b 16 mic_16000_s16le_channel_7.raw channel_7.wav
</code></pre>
<h5 id="play-the-wav-file-ie-audio-from-channel-0">Play the wav file (i.e. audio from channel 0)</h5>
<pre><code>aplay channel_0.wav
</code></pre> 
        </div>
        <div class="toc-parent col-lg-2">
          <div class="toc">
            
            <h3>Contents</h3>
            <ul>
               <li>
  <a href="#microphone" class="active">
    Microphone
  </a>
  
  <ul>
    
    <li>
      <a href="#1-mic-array-on-matrix-creator">
        1. Mic Array on MATRIX Creator
      </a>
    </li>
    
    <li>
      <a href="#2-how-to-get-microphone-data-from-c">
        2. How to get microphone data from C++
      </a>
    </li>
    
    <li>
      <a href="#3-example-demo-apps-for-mics">
        3. Example demo apps for mics
      </a>
    </li>
    
    <li>
      <a href="#record-convert-and-play-sounds">
        Record, Convert and Play sounds.
      </a>
    </li>
    
  </ul>
  
</li> 
            </ul>
          </div>
        </div>
        
      </div>
    </div>
  </div>
  </div>

  <footer class="container">
  <div class="row">
    <div class="col-lg-8">
      <div class="row">
        <div class="col-sm-4">
          <h5>MATRIX</h5>
          <ul>
            <li>
              <a href="https://apps.matrix.one/" target="blank">Apps</a>
            </li>
            <li>
              <a href="/">Creator</a>
            </li>
            <li>
              <a href="/">Voice</a>
            </li>
            <!--<li>
              <a href="/">Store</a>
            </li>-->
          </ul>
        </div>
        <div class="col-sm-4">
          <h5>Learn</h5>
          <ul>
            <li>
              <a href="/">Blog</a>
            </li>
            <li>
              <a href="/">Community</a>
            </li>
            <li>
              <a href="/">Docs</a>
            </li>
            <li>
              <a href="/">MATRIX Ecosystem</a>
            </li>
          </ul>
        </div>
        <div class="col-sm-4">
          <h5>Social Network</h5>
          <ul>
            <li>
              <a href="/">Facebook</a>
            </li>
            <li>
              <a href="/">Twitter</a>
            </li>
            <li>
              <a href="/">YouTube</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <h5>Contact</h5>
      <ul>
        <li>
          <a href="mailto:contact@matrix.one">contact@matrix.one</a>
        </li>
        <li class="subscribe-box">
          <div class="input-group">
            <input type="text" class="form-control" placeholder="Subscribe for Updates">
            <button type="button" class="btn btn-success">Subscribe</button>
          </div>
        </li>
      </ul>
    </div>
  </div>
  <div class="row">
    <div class="col-sm-6 push-sm-6">
      <div class="utility-links">
        <a href="/">Terms of Service</a>
        <a href="/">Privacy Policy</a>
        <a href="/">Cookie Policy</a>
      </div>
    </div>
    <div class="col-sm-6 pull-sm-6">
      <a href="/" class="company-logo">
        <img src="../../../img/everloop.png" width="38" height="38" class="d-inline-block align-top" alt="">
        <span>MATRIX</span>
      </a>
      <small class="copyright">
        2016 - 2017 &copy; MATRIX - All rights reserved
      </small>
    </div>
  </div>
</footer>

  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
  <script src="../../../js/theme.js"></script>
  <script src="https://use.fontawesome.com/21aeb6fedc.js"></script>

  <!-- TOC Script -->
  <script>
    jQuery(function($) {
      $('.toc-parent ul li a').on('click', function() {
        var removedElement = $(this)
          .closest('.toc-parent ul li')
          .find('a.active')
          .removeClass('active');

        if (removedElement.length == 0) {
          $('.toc-parent ul li').find('a.active').removeClass('active');
        }

        $(this).addClass('active');
      });
    });
  </script>

   
</body>

</html>